
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 705 – TypedDict: Read-only and other keys | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0705/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta name="description" content="Python Enhancement Proposals (PEPs)">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 705</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 705 – TypedDict: Read-only and other keys</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Alice Purcell &lt;alicederyn&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Sponsor<span class="colon">:</span></dt>
<dd class="field-even">Pablo Galindo &lt;pablogsal&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-odd">Discussions-To<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/pep-705-typeddict-read-only-and-other-keys/36457">Discourse thread</a></dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-even">Topic<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="../topic/typing/">Typing</a></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">07-Nov-2022</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.13</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/archives/list/typing-sig&#64;python.org/thread/6FR6RKNUZU4UY6B6RXC2H4IAHKBU3UKV/" title="Typing-SIG thread">30-Sep-2022</a>,
<a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/2P26R4VH2ZCNNNOQCBZWEM4RNF35OXOW/" title="Python-Dev thread">02-Nov-2022</a>,
<a class="reference external" href="https://discuss.python.org/t/pep-705-typedmapping/24827" title="Discourse thread">14-Mar-2023</a>,
<a class="reference external" href="https://discuss.python.org/t/pep-705-typeddict-read-only-and-other-keys/36457" title="Discourse thread">17-Oct-2023</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#pure-functions">Pure functions</a></li>
<li><a class="reference internal" href="#updating-nested-dicts">Updating nested dicts</a></li>
<li><a class="reference internal" href="#type-discrimination">Type discrimination</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#other-keys-flag"><code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag</a></li>
<li><a class="reference internal" href="#readonly-flag"><code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag</a></li>
<li><a class="reference internal" href="#typing-readonly-type-qualifier"><code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier</a></li>
<li><a class="reference internal" href="#alternative-functional-syntax">Alternative functional syntax</a></li>
<li><a class="reference internal" href="#interaction-with-other-special-types">Interaction with other special types</a></li>
<li><a class="reference internal" href="#inheritance">Inheritance</a></li>
<li><a class="reference internal" href="#type-consistency">Type consistency</a></li>
<li><a class="reference internal" href="#union-operation">Union Operation</a></li>
<li><a class="reference internal" href="#update-operations">Update Operations</a></li>
<li><a class="reference internal" href="#keyword-argument-typing">Keyword argument typing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-alternatives">Rejected Alternatives</a><ul>
<li><a class="reference internal" href="#a-typedmapping-protocol-type">A TypedMapping protocol type</a></li>
<li><a class="reference internal" href="#a-higher-order-readonly-type">A higher-order Readonly type</a></li>
<li><a class="reference internal" href="#preventing-other-keys-with-the-typing-final-decorator">Preventing other keys with the typing.final decorator</a></li>
<li><a class="reference internal" href="#using-different-casing-for-readonly-keyword-or-readonly-type">Using different casing for <code class="docutils literal notranslate"><span class="pre">readonly</span></code> keyword or <code class="docutils literal notranslate"><span class="pre">ReadOnly</span></code> type</a></li>
<li><a class="reference internal" href="#mandate-unsound-type-narrowing">Mandate unsound type narrowing</a></li>
<li><a class="reference internal" href="#make-the-other-keys-flag-a-boolean">Make the <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag a boolean</a></li>
<li><a class="reference internal" href="#use-a-reserved-extra-key">Use a reserved <code class="docutils literal notranslate"><span class="pre">__extra__</span></code> key</a></li>
<li><a class="reference internal" href="#leave-other-keys-to-pep-728">Leave other_keys to PEP-728</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p><a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> defines the structural type <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.TypedDict" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypedDict</span></code></a> for dictionaries with a fixed set of keys.
As <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> is a mutable type, it is difficult to correctly annotate methods which accept read-only parameters in a way that doesn’t prevent valid inputs.
As structural subtypes can add other keys in, it is also difficult for type-checkers to safely define covariant methods like <code class="docutils literal notranslate"><span class="pre">update</span></code>, or support type narrowing.
This PEP proposes two new <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> flags, <code class="docutils literal notranslate"><span class="pre">readonly</span></code> and <code class="docutils literal notranslate"><span class="pre">other_keys</span></code>, plus an associated type qualifier, <code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code>.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation" role="doc-backlink">Motivation</a></h2>
<p>Representing structured data using (potentially nested) dictionaries with string keys is a common pattern in Python programs. <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> allows these values to be type checked when the exact type is known up-front, but it is hard to write read-only code that accepts more specific variants: for instance, where fields may be subtypes or restrict a union of possible types. This is an especially common issue when writing APIs for services, which may support a wide range of input structures, and typically do not need to modify their input.</p>
<section id="pure-functions">
<h3><a class="toc-backref" href="#pure-functions" role="doc-backlink">Pure functions</a></h3>
<p>Consider trying to add type hints to a function <code class="docutils literal notranslate"><span class="pre">movie_string</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">movie_string</span><span class="p">(</span><span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">movie</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">movie</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">movie</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">movie</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span>
</pre></div>
</div>
<p>We could define this <code class="docutils literal notranslate"><span class="pre">Movie</span></code> type using a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NotRequired</span><span class="p">,</span> <span class="n">TypedDict</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
<p>But suppose we have another type where year is required:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MovieRecord</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>Attempting to pass a <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> into <code class="docutils literal notranslate"><span class="pre">movie_string</span></code> results in the error (using mypy):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Argument 1 to &quot;movie_string&quot; has incompatible type &quot;MovieRecord&quot;; expected &quot;Movie&quot;
</pre></div>
</div>
<p>This particular use case should be type-safe, but the type checker correctly stops the
user from passing a <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> into a <code class="docutils literal notranslate"><span class="pre">Movie</span></code> parameter in the general case, because
the <code class="docutils literal notranslate"><span class="pre">Movie</span></code> class has mutator methods that could potentially allow the function to break
the type constraints in <code class="docutils literal notranslate"><span class="pre">MovieRecord</span></code> (e.g. with <code class="docutils literal notranslate"><span class="pre">movie[&quot;year&quot;]</span> <span class="pre">=</span> <span class="pre">None</span></code> or <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">movie[&quot;year&quot;]</span></code>).
The problem disappears if we don’t have mutator methods in <code class="docutils literal notranslate"><span class="pre">Movie</span></code>. This could be achieved by defining an immutable interface using a <a class="pep reference internal" href="../pep-0544/" title="PEP 544 – Protocols: Structural subtyping (static duck typing)">PEP 544</a> <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.Protocol" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Protocol</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>This is very repetitive, easy to get wrong, and is still missing important method definitions like <code class="docutils literal notranslate"><span class="pre">__contains__()</span></code> and <code class="docutils literal notranslate"><span class="pre">keys()</span></code>.</p>
</section>
<section id="updating-nested-dicts">
<h3><a class="toc-backref" href="#updating-nested-dicts" role="doc-backlink">Updating nested dicts</a></h3>
<p>The structural typing of <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> is supposed to permit writing update functions that only constrain the types of entries they modify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasTimestamp</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span> <span class="nc">Logs</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">loglines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">update_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">HasTimestamp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">add_logline</span><span class="p">(</span><span class="n">logs</span><span class="p">:</span> <span class="n">Logs</span><span class="p">,</span> <span class="n">logline</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logs</span><span class="p">[</span><span class="s2">&quot;loglines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logline</span><span class="p">)</span>
    <span class="n">update_timestamp</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
<p>However, this no longer works once you start nesting dictionaries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HasTimestampedMetadata</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">HasTimestamp</span>

<span class="k">class</span> <span class="nc">UserAudit</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Logs</span>

<span class="k">def</span> <span class="nf">update_metadata_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">HasTimestampedMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">rename_user</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">UserAudit</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">update_metadata_timestamp</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># Type check error: &quot;metadata&quot; is not of type HasTimestamp</span>
</pre></div>
</div>
<p>This looks like an error, but is simply due to the (unwanted) ability to overwrite the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> entry held by the <code class="docutils literal notranslate"><span class="pre">HasTimestampedMetadata</span></code> instance with a different <code class="docutils literal notranslate"><span class="pre">HasTimestamp</span></code> instance, that may no longer be a <code class="docutils literal notranslate"><span class="pre">UserAudit</span></code> instance.</p>
<p>It is possible to work around this issue with generics (as of Python 3.11), but it is very complicated, requiring a type parameter for every nested dict.</p>
</section>
<section id="type-discrimination">
<h3><a class="toc-backref" href="#type-discrimination" role="doc-backlink">Type discrimination</a></h3>
<p>Another common idiom in JSON APIs is to discriminate between mutually exclusive choices with a single-entry dictionary, where the key on the dictionary distinguishes between choices, and constrains the associated value type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">director</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">author</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">EntertainmentMovie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span>

<span class="k">class</span> <span class="nc">EntertainmentBook</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">book</span><span class="p">:</span> <span class="n">Book</span>

<span class="n">Entertainment</span> <span class="o">=</span> <span class="n">EntertainmentMovie</span> <span class="o">|</span> <span class="n">EntertainmentBook</span>
</pre></div>
</div>
<p>Users of this pattern expect type-checkers to allow the following pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">entertainment</span><span class="p">:</span> <span class="n">Entertainment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;movie&quot;</span> <span class="ow">in</span> <span class="n">entertainment</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entertainment</span><span class="p">[</span><span class="s2">&quot;movie&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;book&quot;</span> <span class="ow">in</span> <span class="n">entertainment</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entertainment</span><span class="p">[</span><span class="s2">&quot;book&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Theoretically unreachable but common defensive coding</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected entertainment type&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>However, type-checkers will actually raise an error on this code; mypy, for instance, will complain that <code class="docutils literal notranslate"><span class="pre">TypedDict</span> <span class="pre">&quot;EntertainmentBook&quot;</span> <span class="pre">has</span> <span class="pre">no</span> <span class="pre">key</span> <span class="pre">&quot;movie&quot;</span></code> on the third line. This is because <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> does not prevent instances from having keys not specified in the type, and so the check <code class="docutils literal notranslate"><span class="pre">&quot;movie&quot;</span> <span class="pre">in</span> <span class="pre">entertainment</span></code> can return True for an <code class="docutils literal notranslate"><span class="pre">EntertainmentBook</span></code>.</p>
<p>Users can alternatively use a non-total <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> instead of a union:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Entertainment</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span>
    <span class="n">book</span><span class="p">:</span> <span class="n">Book</span>
</pre></div>
</div>
<p>This ensures the <code class="docutils literal notranslate"><span class="pre">get_name</span></code> example type-checks correctly, but it no longer encodes the constraint that exactly one key must be present, meaning other valid code raises spurious type-check failures. In practice, we tend to see code using types like this either casting to the correct type, with the associated risk of mistakes, or moving the <code class="docutils literal notranslate"><span class="pre">in</span></code> checks to dedicated <code class="docutils literal notranslate"><span class="pre">TypeGuard</span></code> functions, reducing readability.</p>
</section>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>The first two motivating examples can be solved by removing the ability to update one or more of the entries in a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>. This does not mean the entries are immutable; a reference to the underlying dictionary could still exist with a different but compatible type in which those entries have mutator operations. As such, these are not “final” entries; using this term would risk confusion with final attributes, which are fully immutable. These entries are “readonly”.</p>
<p>To support this, we propose adding a new boolean flag to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>, <code class="docutils literal notranslate"><span class="pre">readonly</span></code>, which when set to True, removes all mutator operations from the type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NotRequired</span><span class="p">,</span> <span class="n">TypedDict</span>

<span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">director</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">author</span><span class="p">:</span> <span class="nb">str</span>
</pre></div>
</div>
<p>In addition to these benefits, by flagging arguments of a function as read-only (by using a read-only <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> like <code class="docutils literal notranslate"><span class="pre">Movie</span></code> or <code class="docutils literal notranslate"><span class="pre">Book</span></code>), it makes explicit not just to typecheckers but also to users that the function is not going to modify its inputs, which is usually a desireable property of a function interface.</p>
<p>A new <code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier allows removing the ability to mutate individual entries, permitting a mixture of readonly and mutable entries. This is necessary for supporting the second motivating example, updating nested dicts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserAudit</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="n">Logs</span><span class="p">]</span>
</pre></div>
</div>
<p>This PEP only proposes making <code class="docutils literal notranslate"><span class="pre">ReadOnly</span></code> valid in a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>. A possible future extension would be to support it in additional contexts, such as in protocols.</p>
<p>Finally, to support type discrimination, we add a second flag to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>, <code class="docutils literal notranslate"><span class="pre">other_keys</span></code>, which when set to <code class="docutils literal notranslate"><span class="pre">typing.Never</span></code>, prevents instances from holding any key not explicitly listed in the type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EntertainmentMovie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span>

<span class="k">class</span> <span class="nc">EntertainmentBook</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">book</span><span class="p">:</span> <span class="n">Book</span>

<span class="n">Entertainment</span> <span class="o">=</span> <span class="n">EntertainmentMovie</span> <span class="o">|</span> <span class="n">EntertainmentBook</span>

<span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">entertainment</span><span class="p">:</span> <span class="n">Entertainment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="s2">&quot;movie&quot;</span> <span class="ow">in</span> <span class="n">entertainment</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entertainment</span><span class="p">[</span><span class="s2">&quot;movie&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;book&quot;</span> <span class="ow">in</span> <span class="n">entertainment</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entertainment</span><span class="p">[</span><span class="s2">&quot;book&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected entertainment type&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note this is a subset of the functionality of the <a class="reference external" href="https://github.com/python/peps/pull/3441">unmerged proposal of PEP-728</a>.</p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> will gain two new flags: <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> and <code class="docutils literal notranslate"><span class="pre">readonly</span></code>. A new <code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier is added.</p>
<section id="other-keys-flag">
<h3><a class="toc-backref" href="#other-keys-flag" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag</a></h3>
<p>The optional <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> can have the value <code class="docutils literal notranslate"><span class="pre">typing.Never</span></code>, indicating that instances may only contain keys explicitly listed in the type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Album</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">AlbumExtra</span><span class="p">(</span><span class="n">Album</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Runtime error</span>
</pre></div>
</div>
<p>Type-checkers may rely on this restriction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">album_keys</span><span class="p">(</span><span class="n">album</span><span class="p">:</span> <span class="n">Album</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]]:</span>
    <span class="c1"># Type checkers may permit this, but should error if Album did not specify `other_keys=Never`</span>
    <span class="k">return</span> <span class="n">album</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>Type-checkers should prevent operations that would violate this restriction:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AlbumExtra</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">album</span><span class="p">:</span> <span class="n">AlbumExtra</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Flood&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="mi">1990</span><span class="p">,</span> <span class="n">band</span><span class="p">:</span> <span class="s2">&quot;They Might Be Giants&quot;</span> <span class="p">}</span>
<span class="n">album_keys</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>  <span class="c1"># Type check error: extra key &#39;band&#39;</span>
</pre></div>
</div>
<p>This PEP does not propose supporting any other values than <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code>. Future or concurrent PEPs may extend this flag to permit other types.</p>
</section>
<section id="readonly-flag">
<h3><a class="toc-backref" href="#readonly-flag" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag</a></h3>
<p>The optional boolean <code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>, when <code class="docutils literal notranslate"><span class="pre">True</span></code>, indicates that no mutator operations (<code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">__delitem__</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, etc.) will be permitted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NamedDict</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">NamedDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">NamedDict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>  <span class="c1"># Type check error: cannot modify a read-only entry</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</section>
<section id="typing-readonly-type-qualifier">
<h3><a class="toc-backref" href="#typing-readonly-type-qualifier" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier is used to indicate that a variable declared in a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> definition may not be mutated by any operation performed on instances of the <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ReadOnly</span>

<span class="k">class</span> <span class="nc">BandAndAlbum</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">album</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="n">Album</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag is equivalent to marking all entries as <code class="docutils literal notranslate"><span class="pre">ReadOnly[]</span></code>, guaranteeing no entries are missed by mistake. To avoid potential confusion, it is an error to use both <code class="docutils literal notranslate"><span class="pre">readonly=True</span></code> and <code class="docutils literal notranslate"><span class="pre">ReadOnly[]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Band</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># Runtime error: redundant ReadOnly qualifier</span>
    <span class="n">members</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="alternative-functional-syntax">
<h3><a class="toc-backref" href="#alternative-functional-syntax" role="doc-backlink">Alternative functional syntax</a></h3>
<p>The <a class="pep reference internal" href="../pep-0589/#alternative-syntax" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys § Alternative Syntax">alternative functional syntax</a> for TypedDict also supports these features:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>EntityBand = TypedDict(&#39;EntityBand&#39;, {&#39;band&#39;: Band}, readonly=True, other_keys=Never)
BandAndAlbum = TypedDict(`BandAndAlbum&#39;, {&#39;band&#39;: str, &#39;album&#39;: ReadOnly[Album]})
</pre></div>
</div>
</section>
<section id="interaction-with-other-special-types">
<h3><a class="toc-backref" href="#interaction-with-other-special-types" role="doc-backlink">Interaction with other special types</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ReadOnly[]</span></code> can be used with <code class="docutils literal notranslate"><span class="pre">Required[]</span></code>, <code class="docutils literal notranslate"><span class="pre">NotRequired[]</span></code> and <code class="docutils literal notranslate"><span class="pre">Annotated[]</span></code>, in any nesting order:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="n">Required</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>  <span class="c1"># OK</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="n">NotRequired</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ValueRange</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)]]]</span>  <span class="c1"># OK</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Required</span><span class="p">[</span><span class="n">ReadOnly</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>  <span class="c1"># OK</span>
    <span class="n">year</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">NotRequired</span><span class="p">[</span><span class="n">ReadOnly</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">ValueRange</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)]</span>  <span class="c1"># OK</span>
</pre></div>
</div>
<p>This is consistent with the behavior introduced in <a class="pep reference internal" href="../pep-0655/" title="PEP 655 – Marking individual TypedDict items as required or potentially-missing">PEP 655</a>.</p>
</section>
<section id="inheritance">
<h3><a class="toc-backref" href="#inheritance" role="doc-backlink">Inheritance</a></h3>
<p>To avoid potential confusion, it is an error to have a read-only type extend a non-read-only type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BandAndAlbum</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">band</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">album</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="n">Album</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">BandAlbumAndLabel</span><span class="p">(</span><span class="n">BandAndAlbum</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># Runtime error</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
</pre></div>
</div>
<p>It is also an error to have a type without <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> specified extend a type with <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Building</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Museum</span><span class="p">(</span><span class="n">Building</span><span class="p">):</span>  <span class="c1"># Runtime error</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>It is valid to have a non-read-only type extend a read-only one. The subclass will not be read-only, but any keys not redeclared in the subclass will remain read-only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NamedDict</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Album</span><span class="p">(</span><span class="n">NamedDict</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">album</span><span class="p">:</span> <span class="n">Album</span> <span class="o">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Flood&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="mi">1990</span> <span class="p">}</span>
<span class="n">album</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1973</span>  <span class="c1"># OK</span>
<span class="n">album</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dark Side Of The Moon&quot;</span>  <span class="c1"># Type check error: &quot;name&quot; is read-only</span>
</pre></div>
</div>
<p>Subclasses can redeclare read-only entries as non-read-only, allowing them to be mutated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Album</span><span class="p">(</span><span class="n">NamedDict</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">album</span><span class="p">:</span> <span class="n">Album</span> <span class="o">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Flood&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="mi">1990</span> <span class="p">}</span>
<span class="n">album</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1973</span>  <span class="c1"># OK</span>
<span class="n">album</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dark Side Of The Moon&quot;</span>  <span class="c1"># Also OK now</span>
</pre></div>
</div>
<p>Subclasses can narrow value types of read-only entries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AlbumCollection</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">albums</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Album</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">RecordShop</span><span class="p">(</span><span class="n">AlbumCollection</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">albums</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Album</span><span class="p">]</span>
</pre></div>
</div>
<p>Subclasses can also require keys that are read-only but not required in the superclass:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionalName</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">OptionalName</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Required</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="n">person</span><span class="p">:</span> <span class="n">Person</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Type check error: &quot;name&quot; required</span>
</pre></div>
</div>
<p>Note that these are just consequences of structural typing, but they are highlighted here as the behavior now differs from the rules specified in <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a>.</p>
<p>Finally, subclasses can have <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code> even if the superclass does not:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">OptionalName</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Required</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="type-consistency">
<h3><a class="toc-backref" href="#type-consistency" role="doc-backlink">Type consistency</a></h3>
<p><em>This section updates the type consistency rules introduced in</em> <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> <em>to cover the new features in this PEP. In particular, any pair of types that do not use the new features will be consistent under these new rules if (and only if) they were already consistent.</em></p>
<p>A TypedDict type with <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code> is consistent with <code class="docutils literal notranslate"><span class="pre">Mapping[str,</span> <span class="pre">V]</span></code>, where <code class="docutils literal notranslate"><span class="pre">V</span></code> is the union of all its value types. For instance, the following type is consistent with <code class="docutils literal notranslate"><span class="pre">Mapping[str,</span> <span class="pre">int</span> <span class="pre">|</span> <span class="pre">str]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
<p>A TypedDict type <code class="docutils literal notranslate"><span class="pre">A</span></code> is consistent with TypedDict <code class="docutils literal notranslate"><span class="pre">B</span></code> if <code class="docutils literal notranslate"><span class="pre">A</span></code> is structurally compatible with <code class="docutils literal notranslate"><span class="pre">B</span></code>. This is true if and only if all of the following are satisfied:</p>
<ul class="simple">
<li>For each key in <code class="docutils literal notranslate"><span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">A</span></code> has the corresponding key and the corresponding value type in <code class="docutils literal notranslate"><span class="pre">A</span></code> is consistent with the value type in <code class="docutils literal notranslate"><span class="pre">B</span></code>, unless the key in <code class="docutils literal notranslate"><span class="pre">B</span></code> is of type <code class="docutils literal notranslate"><span class="pre">ReadOnly[NotRequired[Any]]</span></code>, in which case it may be missing in <code class="docutils literal notranslate"><span class="pre">A</span></code> provided <code class="docutils literal notranslate"><span class="pre">A</span></code> allows other keys.</li>
<li>For each non-read-only key in <code class="docutils literal notranslate"><span class="pre">B</span></code>, the corresponding value type in <code class="docutils literal notranslate"><span class="pre">B</span></code> is also consistent with the corresponding value type in <code class="docutils literal notranslate"><span class="pre">A</span></code>.</li>
<li>For each required key in <code class="docutils literal notranslate"><span class="pre">B</span></code>, the corresponding key is required in <code class="docutils literal notranslate"><span class="pre">A</span></code>.</li>
<li>For each non-read-only, non-required key in <code class="docutils literal notranslate"><span class="pre">B</span></code>, the corresponding key is not required in <code class="docutils literal notranslate"><span class="pre">A</span></code>.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">B</span></code> does not allow other keys, then <code class="docutils literal notranslate"><span class="pre">A</span></code> does not allow other keys.</li>
<li>If <code class="docutils literal notranslate"><span class="pre">B</span></code> does not allow other keys, then for each key in <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code> has the corresponding key.</li>
</ul>
<p>Discussion:</p>
<ul>
<li>All non-specified keys in a type that allows other keys are implicitly of type <code class="docutils literal notranslate"><span class="pre">ReadOnly[NotRequired[Any]]</span></code> (or <code class="docutils literal notranslate"><span class="pre">ReadOnly[NotRequired[Unknown]]</span></code> in pyright).</li>
<li>Read-only value types behave covariantly, as they cannot be mutated. This is similar to container types such as <code class="docutils literal notranslate"><span class="pre">Sequence</span></code>, and different from non-read-only value types, which behave invariantly. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">b</span><span class="p">:</span> <span class="n">B</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
</li>
<li>A TypedDict type <code class="docutils literal notranslate"><span class="pre">A</span></code> with no explicit key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> that allows other keys is not consistent with a TypedDict type with a non-required key <code class="docutils literal notranslate"><span class="pre">'x'</span></code>, since at runtime the key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> could be present and have an incompatible type (which may not be visible through <code class="docutils literal notranslate"><span class="pre">A</span></code> due to structural subtyping). The only exception to this rule is if <code class="docutils literal notranslate"><span class="pre">'x'</span></code> is non-required, read-only and of type <code class="docutils literal notranslate"><span class="pre">object</span></code> (or <code class="docutils literal notranslate"><span class="pre">Any</span></code> or pylance’s <code class="docutils literal notranslate"><span class="pre">Unknown</span></code>).</li>
<li>A TypedDict type <code class="docutils literal notranslate"><span class="pre">A</span></code> with no key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> that does not allow other keys may be consistent with a TypedDict type with a read-only, non-required key <code class="docutils literal notranslate"><span class="pre">'x'</span></code>. Example:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
   <span class="n">b</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="union-operation">
<h3><a class="toc-backref" href="#union-operation" role="doc-backlink">Union Operation</a></h3>
<p>The union operation creates a new dictionary with the merged keys and values of its two operands. As such, the result should be consistent with any type that can hold the possible key-value pairs, not just types compatible with the operand types. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">union_a_b</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">C</span><span class="p">:</span>
    <span class="c1"># Accepted by type-checker, even though C is not read-only and</span>
    <span class="c1"># allows other keys:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">|</span> <span class="n">b</span>
</pre></div>
</div>
<p>This is different from the usual compatibility rules, where the result of an operation has a defined type which the variable it is assigned to must be consistent with. A similar situation occurs with <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> and <code class="docutils literal notranslate"><span class="pre">copy()</span></code> or <code class="docutils literal notranslate"><span class="pre">deepcopy()</span></code>.</p>
<p>If the union of two TypedDict objects of type <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> are assigned to a TypedDict of type <code class="docutils literal notranslate"><span class="pre">C</span></code>, the type checker should verify that:</p>
<ul class="simple">
<li>if <code class="docutils literal notranslate"><span class="pre">C</span></code> does not allow other keys, neither <code class="docutils literal notranslate"><span class="pre">A</span></code> nor <code class="docutils literal notranslate"><span class="pre">B</span></code> allow other keys</li>
<li>if <code class="docutils literal notranslate"><span class="pre">C</span></code> does not allow other keys, it contains all keys found in either <code class="docutils literal notranslate"><span class="pre">A</span></code> or <code class="docutils literal notranslate"><span class="pre">B</span></code></li>
<li>if a key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> is found in <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code>, its type in <code class="docutils literal notranslate"><span class="pre">A</span></code> is consistent with its type in <code class="docutils literal notranslate"><span class="pre">C</span></code>.</li>
<li>if a key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> is found in <code class="docutils literal notranslate"><span class="pre">B</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code>, its type in <code class="docutils literal notranslate"><span class="pre">B</span></code> is consistent with its type in <code class="docutils literal notranslate"><span class="pre">C</span></code>.</li>
<li>if a key <code class="docutils literal notranslate"><span class="pre">'x'</span></code> is required in <code class="docutils literal notranslate"><span class="pre">C</span></code>, it is required in either <code class="docutils literal notranslate"><span class="pre">A</span></code> or <code class="docutils literal notranslate"><span class="pre">B</span></code>.</li>
</ul>
<p>Notes:</p>
<ul class="simple">
<li>The read-only status of the keys does not matter. A key can be read-only on just <code class="docutils literal notranslate"><span class="pre">A</span></code>, just <code class="docutils literal notranslate"><span class="pre">B</span></code>, or just <code class="docutils literal notranslate"><span class="pre">C</span></code>, or any combination.</li>
<li>A key found on <code class="docutils literal notranslate"><span class="pre">A</span></code> or <code class="docutils literal notranslate"><span class="pre">B</span></code> may be missed off <code class="docutils literal notranslate"><span class="pre">C</span></code> if it allows other keys. Type-checkers may however choose to flag this edge-case with a warning or error in some circumstances, if it is found to be a source of mistakes.</li>
</ul>
</section>
<section id="update-operations">
<h3><a class="toc-backref" href="#update-operations" role="doc-backlink">Update Operations</a></h3>
<p>Previously, <code class="docutils literal notranslate"><span class="pre">clear()</span></code> and <code class="docutils literal notranslate"><span class="pre">popitem()</span></code> were rejected by type checkers on TypedDict objects, as they could remove required keys, some of which may not be directly visible because of structural subtyping. However, these methods should be allowed on TypedDicts objects with all keys non-read-only and non-required and with no other keys allowed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">a</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span> <span class="p">}</span>
<span class="n">a</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>  <span class="c1"># Accepted by type checker</span>
<span class="n">a</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Accepted by type checker</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update</span></code> has been difficult to type correctly due to the open nature of TypedDict objects. Keys not specified on the type could still be present (and constrained) due to structural subtyping, meaning type safety could be accidentally violated. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">update_b</span><span class="p">(</span><span class="n">b1</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">b1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">c</span><span class="p">:</span> <span class="n">C</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
<span class="n">d</span><span class="p">:</span> <span class="n">D</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span> <span class="p">}</span>
<span class="n">update_b</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># c is no longer a C at runtime</span>
</pre></div>
</div>
<p>Both mypy and pyright currectly permit this usage, however, as the only viable alternative has been to prevent calling <code class="docutils literal notranslate"><span class="pre">update</span></code> at all.</p>
<p>With the addition of <code class="docutils literal notranslate"><span class="pre">other_keys</span></code>, it becomes possible to more accurately type the update method:</p>
<ul class="simple">
<li>Declare a new read-only TypedDict type that does not allow other keys</li>
<li>Copy all non-read-only entries to it</li>
<li>Make all entries read-only and non-required</li>
<li>Union this with an iterable of matching key-value pairs</li>
</ul>
<p>For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">c</span><span class="p">:</span> <span class="n">ReadOnly</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ExampleUpdateDict</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">other_keys</span><span class="o">=</span><span class="n">Never</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">b</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># c is not present as it is read-only in Example</span>

<span class="n">ExampleUpdateEntry</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
<span class="n">ExampleUpdate</span> <span class="o">=</span> <span class="n">ExampleUpdateDict</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ExampleUpdateEntry</span><span class="p">]</span>
</pre></div>
</div>
<p>Type checkers should permit any type compatible with this TypedDict to be passed into the update operation. As with <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a>, they may choose to continue permitting TypedDict types that allow other keys as well, to avoid generating false positives.</p>
</section>
<section id="keyword-argument-typing">
<h3><a class="toc-backref" href="#keyword-argument-typing" role="doc-backlink">Keyword argument typing</a></h3>
<p><a class="pep reference internal" href="../pep-0692/" title="PEP 692 – Using TypedDict for more precise **kwargs typing">PEP 692</a> introduced <code class="docutils literal notranslate"><span class="pre">Unpack</span></code> to annotate <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> with a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>. Marking one or more of the entries of a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> used in this way as read-only will have no effect on the type signature of the method, since all keyword arguments are read-only by design in Python. However, it <em>will</em> prevent the entry from being modified in the body of the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">key1</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">key2</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">ReadonlyArgs</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">key1</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">key2</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">Args</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">ReadonlyArgs</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;key1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Type check error: key1 is readonly</span>

<span class="n">fn</span><span class="p">:</span> <span class="n">Function</span> <span class="o">=</span> <span class="n">impl</span>  <span class="c1"># Accepted by type checker: function signatures are identical</span>
</pre></div>
</div>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards compatibility</a></h2>
<p>This PEP adds new features to <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code>, so code that inspects <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> types will have to change to support types using the new features. This is expected to mainly affect type-checkers.</p>
</section>
<section id="security-implications">
<h2><a class="toc-backref" href="#security-implications" role="doc-backlink">Security implications</a></h2>
<p>There are no known security consequences arising from this PEP.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>Suggestion for changes to the <a class="reference external" href="https://docs.python.org/3/library/typing.html#module-typing" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">typing</span></code></a> module, in line with current practice:</p>
<ul class="simple">
<li>Add this PEP to the others listed.</li>
<li>Add <code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code>, linked to TypedDict and this PEP.</li>
<li>Add the following text to the TypedDict entry:</li>
</ul>
<p>By default, keys not specified in a TypedDict may still be present. Instances can be restricted to only the named keys with the <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag. <em>insert example, perhaps using ``in`` to illustrate the benefit</em></p>
<p>Individual keys can be excluded from mutate operations using ReadOnly, allowing them to be read but not changed. This is useful when the exact type of the value is not known yet, and so modifying it would break structural subtypes. <em>insert example</em></p>
<p>If all keys on a TypedDict should be read-only, the <code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag can be used as a shorthand. <em>insert example</em></p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p>No complete reference implementation exists yet. pyright 1.1.310 ships with a partial implementation of the ReadOnly qualifier.</p>
</section>
<section id="rejected-alternatives">
<h2><a class="toc-backref" href="#rejected-alternatives" role="doc-backlink">Rejected Alternatives</a></h2>
<section id="a-typedmapping-protocol-type">
<h3><a class="toc-backref" href="#a-typedmapping-protocol-type" role="doc-backlink">A TypedMapping protocol type</a></h3>
<p>An earlier version of <a class="pep reference internal" href="../pep-0705/" title="PEP 705 – TypedDict: Read-only and other keys">PEP 705</a> proposed a <code class="docutils literal notranslate"><span class="pre">TypedMapping</span></code> protocol type, behaving much like a read-only TypedDict but without the constraint that the runtime type be a <code class="docutils literal notranslate"><span class="pre">dict</span></code>. The behavior described in the current version of this PEP could then be obtained by inheriting a TypedDict from a TypedMapping. This has been set aside for now as more complex, without a strong use-case motivating the additional complexity.</p>
</section>
<section id="a-higher-order-readonly-type">
<h3><a class="toc-backref" href="#a-higher-order-readonly-type" role="doc-backlink">A higher-order Readonly type</a></h3>
<p>A generalized higher-order type could be added that removes mutator methods from its parameter, e.g. <code class="docutils literal notranslate"><span class="pre">ReadOnly[MovieRecord]</span></code>. For a TypedDict, this would be like adding <code class="docutils literal notranslate"><span class="pre">readonly=True</span></code> to the declaration. This would naturally want to be defined for a wider set of types than just TypedDict subclasses, and also raises questions about whether and how it applies to nested types. We decided to keep the scope of this PEP narrower.</p>
</section>
<section id="preventing-other-keys-with-the-typing-final-decorator">
<h3><a class="toc-backref" href="#preventing-other-keys-with-the-typing-final-decorator" role="doc-backlink">Preventing other keys with the typing.final decorator</a></h3>
<p>Instead of adding an <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag to TypedDict, treat classes decorated with <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.final" title="(in Python v3.12)"><code class="xref py py-func docutils literal notranslate"><span class="pre">final()</span></code></a> as disallowing other keys. This makes intuitive sense for TypedDict as it stands now: preventing adding any other keys guarantees no other types will be structurally compatible, so it is effectively final. There is also partial support for this idiom in mypy and pyright, which both use it as a way to achieve type discrimination. However, if any keys are read-only, preventing adding any other keys does <strong>not</strong> make the type final any more, so using the decorator this way seems incorrect. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="o">...</span>
<span class="k">class</span> <span class="nc">Bar</span><span class="p">(</span><span class="n">Foo</span><span class="p">):</span> <span class="o">...</span>

<span class="nd">@final</span>
<span class="k">class</span> <span class="nc">FooHolder</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="n">item</span><span class="p">:</span> <span class="n">Foo</span>

<span class="nd">@final</span>
<span class="k">class</span> <span class="nc">BarHolder</span><span class="p">(</span><span class="n">FooHolder</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="n">item</span><span class="p">:</span> <span class="n">Bar</span>
</pre></div>
</div>
<p>Extending a <code class="docutils literal notranslate"><span class="pre">TypedDict</span></code> to refine the types is a reasonable feature, but the above code looks like it should raise a runtime error. Should <code class="docutils literal notranslate"><span class="pre">&#64;final</span></code> be modified to allow inheritance? Should users be prevented from using this pattern?</p>
<p>More context for this can be found on <a class="reference external" href="https://github.com/microsoft/pyright/issues/5254">pyright issue 5254</a>.</p>
<p>We recommend type checkers treat decorating a TypedDict type with final as identical to setting <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code>, if they continue to support the idiom for backwards compatibility, but reject any use of final on a TypedDict with read-only keys. Once <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> is adopted, they may also wish to deprecate use of final on TypedDicts entirely.</p>
</section>
<section id="using-different-casing-for-readonly-keyword-or-readonly-type">
<h3><a class="toc-backref" href="#using-different-casing-for-readonly-keyword-or-readonly-type" role="doc-backlink">Using different casing for <code class="docutils literal notranslate"><span class="pre">readonly</span></code> keyword or <code class="docutils literal notranslate"><span class="pre">ReadOnly</span></code> type</a></h3>
<p>It appears to be common convention to put an initial caps onto words separated by a dash when converting to CamelCase, but to drop the dash completely when converting to snake_case. Django uses <code class="docutils literal notranslate"><span class="pre">readonly</span></code>, for instance. This appears consistent with the definition of both on Wikipedia: snake_case replaces spaces with dashes, while CamelCase uppercases the first letter of each word. That said, more examples or counterexamples, ideally from the core Python libraries, or better explicit guidance on the convention, would be greatly appreciated.</p>
</section>
<section id="mandate-unsound-type-narrowing">
<h3><a class="toc-backref" href="#mandate-unsound-type-narrowing" role="doc-backlink">Mandate unsound type narrowing</a></h3>
<p>The main use-case we are aware of for <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code> (and the current workaround of final-decorated TypedDict types) is to simplify type discrimination, as shown in the motivation section.</p>
<p>By comparison, TypeScript handles this edge-case by ignoring the possibility of instances of one type in the union having undeclared keys. If a variable is known to be of type <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">|</span> <span class="pre">B</span></code> and an <code class="docutils literal notranslate"><span class="pre">in</span></code> check is done using a key not explicitly declared on <code class="docutils literal notranslate"><span class="pre">B</span></code>, it is assumed no instance of <code class="docutils literal notranslate"><span class="pre">B</span></code> will pass that check. While technically unsound, this a common enough idiom that it could fall under the recommendation in <a class="pep reference internal" href="../pep-0589/" title="PEP 589 – TypedDict: Type Hints for Dictionaries with a Fixed Set of Keys">PEP 589</a> that “potentially unsafe operations may be accepted if the alternative is to generate false positive errors for idiomatic code”.</p>
<p>This user request has been rejected multiple times by type checkers, however, suggesting the community prefers strict type-safety over idiomatic code here.</p>
</section>
<section id="make-the-other-keys-flag-a-boolean">
<h3><a class="toc-backref" href="#make-the-other-keys-flag-a-boolean" role="doc-backlink">Make the <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag a boolean</a></h3>
<p>Since <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> can only effectively take two values, <code class="docutils literal notranslate"><span class="pre">Never</span></code> or absent, it was originally proposed as a boolean flag, with <code class="docutils literal notranslate"><span class="pre">other_keys=False</span></code> equivalent to the current <code class="docutils literal notranslate"><span class="pre">other_keys=Never</span></code>. However, the <a class="reference external" href="https://github.com/python/peps/pull/3441">unmerged proposal of PEP-728</a> provides equivalent functionality when restricting other types to <code class="docutils literal notranslate"><span class="pre">Never</span></code>, so this proposal was updated to use comparable syntax, to make it clearer how the proposals intersect.</p>
</section>
<section id="use-a-reserved-extra-key">
<h3><a class="toc-backref" href="#use-a-reserved-extra-key" role="doc-backlink">Use a reserved <code class="docutils literal notranslate"><span class="pre">__extra__</span></code> key</a></h3>
<p>The <a class="reference external" href="https://github.com/python/peps/pull/3441">unmerged proposal of PEP-728</a> proposes different syntax for disallowing other keys:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EntertainmentMovie</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">movie</span><span class="p">:</span> <span class="n">Movie</span>
    <span class="n">__extra__</span><span class="p">:</span> <span class="n">Never</span>
</pre></div>
</div>
<p>This new key does not function like other keys – for instance, it is implicitly <code class="docutils literal notranslate"><span class="pre">NotRequired</span></code> but cannot be explicitly marked as such. The author of this PEP prefers the asymmetry of using a keyword argument to set expectations that it does not behave like other key declarations, and others have provided similar feedback on the PR.</p>
<p>However, this PEP will be updated to match whatever syntax the PEP-728 author decides to go with.</p>
</section>
<section id="leave-other-keys-to-pep-728">
<h3><a class="toc-backref" href="#leave-other-keys-to-pep-728" role="doc-backlink">Leave other_keys to PEP-728</a></h3>
<p>This PEP could drop the <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> proposal entirely rather than propose a limited subset of it. However, as this PEP affects the unofficial status-quo of using final to disallow other keys, it seems important to both highlight that issue and propose a solution.</p>
</section>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0705.rst">https://github.com/python/peps/blob/main/peps/pep-0705.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0705.rst">2023-10-18 19:09:45 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a><ul>
<li><a class="reference internal" href="#pure-functions">Pure functions</a></li>
<li><a class="reference internal" href="#updating-nested-dicts">Updating nested dicts</a></li>
<li><a class="reference internal" href="#type-discrimination">Type discrimination</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#other-keys-flag"><code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag</a></li>
<li><a class="reference internal" href="#readonly-flag"><code class="docutils literal notranslate"><span class="pre">readonly</span></code> flag</a></li>
<li><a class="reference internal" href="#typing-readonly-type-qualifier"><code class="docutils literal notranslate"><span class="pre">typing.ReadOnly</span></code> type qualifier</a></li>
<li><a class="reference internal" href="#alternative-functional-syntax">Alternative functional syntax</a></li>
<li><a class="reference internal" href="#interaction-with-other-special-types">Interaction with other special types</a></li>
<li><a class="reference internal" href="#inheritance">Inheritance</a></li>
<li><a class="reference internal" href="#type-consistency">Type consistency</a></li>
<li><a class="reference internal" href="#union-operation">Union Operation</a></li>
<li><a class="reference internal" href="#update-operations">Update Operations</a></li>
<li><a class="reference internal" href="#keyword-argument-typing">Keyword argument typing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards compatibility</a></li>
<li><a class="reference internal" href="#security-implications">Security implications</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-alternatives">Rejected Alternatives</a><ul>
<li><a class="reference internal" href="#a-typedmapping-protocol-type">A TypedMapping protocol type</a></li>
<li><a class="reference internal" href="#a-higher-order-readonly-type">A higher-order Readonly type</a></li>
<li><a class="reference internal" href="#preventing-other-keys-with-the-typing-final-decorator">Preventing other keys with the typing.final decorator</a></li>
<li><a class="reference internal" href="#using-different-casing-for-readonly-keyword-or-readonly-type">Using different casing for <code class="docutils literal notranslate"><span class="pre">readonly</span></code> keyword or <code class="docutils literal notranslate"><span class="pre">ReadOnly</span></code> type</a></li>
<li><a class="reference internal" href="#mandate-unsound-type-narrowing">Mandate unsound type narrowing</a></li>
<li><a class="reference internal" href="#make-the-other-keys-flag-a-boolean">Make the <code class="docutils literal notranslate"><span class="pre">other_keys</span></code> flag a boolean</a></li>
<li><a class="reference internal" href="#use-a-reserved-extra-key">Use a reserved <code class="docutils literal notranslate"><span class="pre">__extra__</span></code> key</a></li>
<li><a class="reference internal" href="#leave-other-keys-to-pep-728">Leave other_keys to PEP-728</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0705.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
</body>
</html>